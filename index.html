// ============================================
// V2Ray Config Generator for Deno Deploy
// Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ ØªØ¶Ù…ÛŒÙ†ÛŒ
// ============================================

const UUID = "d342d11e-d424-4583-b36e-524ab1f0afa4";

Deno.serve((req: Request) => {
  const url = new URL(req.url);
  const host = req.headers.get("host") || "localhost";
  
  // ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ
  if (url.pathname === "/") {
    return new Response(getHtml(host, UUID), {
      headers: { "content-type": "text/html; charset=utf-8" }
    });
  }
  
  // ÙØ§ÛŒÙ„ Ú©Ø§Ù†ÙÛŒÚ¯
  if (url.pathname === "/vless.txt" || url.pathname === "/config") {
    const config = `vless://${UUID}@${host}:443?encryption=none&security=tls&sni=${host}&type=ws&host=${host}&path=%2Fvless%3Fed%3D2048#Deno-${host.split('.')[0]}`;
    return new Response(config, {
      headers: { 
        "content-type": "text/plain; charset=utf-8",
        "cache-control": "no-cache"
      }
    });
  }
  
  // ÙˆØ¶Ø¹ÛŒØª JSON
  if (url.pathname === "/status") {
    return new Response(JSON.stringify({
      status: "online",
      uuid: UUID,
      host: host,
      timestamp: new Date().toISOString()
    }), {
      headers: { "content-type": "application/json" }
    });
  }
  
  // 404
  return new Response("404 - Not Found", { status: 404 });
});

function getHtml(host: string, uuid: string): string {
  return `<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>V2Ray Config Generator</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Tahoma', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    h1 {
      color: white;
      font-size: 2.5rem;
      margin-bottom: 20px;
      text-align: center;
    }
    .status {
      background: #4CAF50;
      padding: 10px;
      border-radius: 10px;
      text-align: center;
      margin: 20px 0;
      color: white;
      font-weight: bold;
    }
    .config-box {
      background: #1a1a1a;
      color: #00ff00;
      padding: 20px;
      border-radius: 10px;
      direction: ltr;
      word-break: break-all;
      margin: 20px 0;
      border: 2px solid #4CAF50;
      font-family: monospace;
    }
    .btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px;
      transition: all 0.3s;
    }
    .btn:hover { transform: scale(1.05); }
    .btn-blue { background: #2196F3; }
    .info {
      background: rgba(0,0,0,0.3);
      padding: 15px;
      border-radius: 10px;
      margin: 10px 0;
      color: white;
    }
    .footer {
      text-align: center;
      margin-top: 30px;
      color: rgba(255,255,255,0.7);
      font-size: 14px;
    }
    @media (max-width: 600px) {
      .container { padding: 20px; }
      h1 { font-size: 2rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ V2Ray Config Generator</h1>
    
    <div class="status">âœ… Ø³Ø±ÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙØ¹Ø§Ù„ Ø´Ø¯</div>
    
    <div class="info">
      <p><strong>ğŸ”‘ UUID:</strong> ${uuid}</p>
      <p><strong>ğŸŒ Ø¢Ø¯Ø±Ø³:</strong> ${host}</p>
      <p><strong>ğŸ“¡ Ù¾Ø±ÙˆØªÚ©Ù„:</strong> VLESS + WebSocket</p>
      <p><strong>â° Ø²Ù…Ø§Ù†:</strong> ${new Date().toLocaleString('fa-IR')}</p>
    </div>
    
    <h3 style="color: white;">ğŸ“¦ Ú©Ø§Ù†ÙÛŒÚ¯ VLESS:</h3>
    <div class="config-box" id="config">
vless://${uuid}@${host}:443?encryption=none&security=tls&sni=${host}&fp=randomized&type=ws&host=${host}&path=%2Fvless%3Fed%3D2048#Deno-${host.split('.')[0]}
    </div>
    
    <div style="text-align: center;">
      <button class="btn" onclick="copyConfig()">ğŸ“‹ Ú©Ù¾ÛŒ Ú©Ø§Ù†ÙÛŒÚ¯</button>
      <button class="btn btn-blue" onclick="window.open('/vless.txt')">ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„</button>
    </div>
    
    <div style="margin-top: 30px; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;">
      <h4 style="color: white;">ğŸ“± Ø±ÙˆØ´ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± V2RayNG:</h4>
      <ol style="color: white; margin-right: 20px;">
        <li>Ø¨Ø±Ù†Ø§Ù…Ù‡ V2RayNG Ø±Ùˆ Ø¨Ø§Ø² Ú©Ù†</li>
        <li>Ø±ÙˆÛŒ + Ú©Ù„ÛŒÚ© Ú©Ù†</li>
        <li>Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† "Import Config from URL"</li>
        <li>Ù„ÛŒÙ†Ú© Ø±Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù†: <strong style="direction: ltr; display: block; background: #333; padding: 10px; margin-top: 10px; border-radius: 5px;">https://${host}/vless.txt</strong></li>
      </ol>
    </div>
    
    <div class="footer">
      <p>âœ¨ Ù¾Ø±ÙˆÚ˜Ù‡ Ø´Ø®ØµÛŒ jde1etxl6w | Deno Deploy | 2026</p>
    </div>
  </div>

  <script>
    function copyConfig() {
      const config = document.getElementById('config').innerText;
      navigator.clipboard.writeText(config).then(() => {
        alert('âœ… Ú©Ø§Ù†ÙÛŒÚ¯ Ú©Ù¾ÛŒ Ø´Ø¯!');
      });
    }
  </script>
</body>
</html>`;
}
